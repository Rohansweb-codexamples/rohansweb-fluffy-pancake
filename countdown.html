<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>50-Minute Countdown with Cast</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #timer { font-size: 8rem; letter-spacing: 0.1em; text-align: center; }
    #status { margin-top: 1rem; font-size: 1.2rem; opacity: 0.8; }
    #controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }
    button {
      padding: 10px 18px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #1e88e5;
      color: #fff;
    }
    button.secondary { background: #555; }
    button:active { transform: scale(0.98); }
  </style>

  <!-- Load the Cast Web Sender SDK -->
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>
  <div id="timer">50:00</div>
  <div id="status">Music starts in 50 minutes</div>

  <div id="controls">
    <button id="startBtn">Start 50-min Countdown</button>
    <button id="castBtn" class="secondary">Present on connected display</button>
    <button id="resetBtn" class="secondary">Reset</button>
  </div>

  <script>
    // ===== Countdown logic =====
    const DURATION_MINUTES = 50;
    let endTime = null;
    let intervalId = null;

    const timerEl = document.getElementById("timer");
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const castBtn = document.getElementById("castBtn");
    const resetBtn = document.getElementById("resetBtn");

    function formatTime(msRemaining) {
      const totalSeconds = Math.max(0, Math.floor(msRemaining / 1000));
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const mm = String(minutes).padStart(2, "0");
      const ss = String(seconds).padStart(2, "0");
      return `${mm}:${ss}`;
    }

    function updateTimer() {
      if (!endTime) return;
      const now = Date.now();
      const msRemaining = endTime - now;

      if (msRemaining <= 0) {
        clearInterval(intervalId);
        intervalId = null;
        timerEl.textContent = "00:00";
        statusEl.textContent = "Music should be starting now!";
        return;
      }

      timerEl.textContent = formatTime(msRemaining);
      const minutesLeft = Math.ceil(msRemaining / 60000);
      statusEl.textContent = `Music starts in about ${minutesLeft} minute${minutesLeft !== 1 ? "s" : ""}`;
    }

    function startCountdown() {
      const now = Date.now();
      endTime = now + DURATION_MINUTES * 60 * 1000;
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(updateTimer, 250);
      updateTimer();
    }

    function resetCountdown() {
      if (intervalId) clearInterval(intervalId);
      intervalId = null;
      endTime = null;
      timerEl.textContent = "50:00";
      statusEl.textContent = "Music starts in 50 minutes";
    }

    startBtn.addEventListener("click", startCountdown);
    resetBtn.addEventListener("click", resetCountdown);

    // ===== Cast logic =====
    let castContext;

    window.__onGCastApiAvailable = function(isAvailable) {
      if (isAvailable) {
        castContext = cast.framework.CastContext.getInstance();
        castContext.setOptions({
          receiverApplicationId: 'chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID', // or chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED
        });
      }
    };

    async function presentOnConnectedDisplay() {
      if (!castContext) {
        alert("Cast API not ready yet. Try again in a moment.");
        return;
      }

      try {
        // This opens the Cast device picker and starts a session
        await castContext.requestSession();
        // Once casting, Chrome will mirror this tab (or use your receiver app).
        // You can then minimize Chrome; the cast continues.
      } catch (err) {
        console.error("Cast request failed:", err);
      }
    }

    castBtn.addEventListener("click", presentOnConnectedDisplay);
  </script>
</body>
</html>
